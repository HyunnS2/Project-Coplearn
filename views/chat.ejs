<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/chat.css" />
    <script src="/socket.io/socket.io.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>

    <title>Koflearn</title>
    <style></style>
  </head>
  <body>
    <div class="all-container">
      <div class="header-container">
        <div id="title"><div>
        <div class="title-content">
          <!-- <img
            src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAA3klEQVRIDbXBAQEAAAABIP6PzgpAAAACpS6aZKAAAANNDgYz1RnF2SAQAAAABJRU5ErkJggg=="
            data-bs-toggle="modal"
            data-bs-target="#exampleModal"
            id="image_button"
          /> -->
          <div id="user_num">4</div>
        </div>
      </div>
      <div
        class="modal fade"
        id="exampleModal"
        tabindex="-1"
        aria-labelledby="exampleModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              참여한 사용자
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <ul id="userList">
                <li>예시</li>
                <li>예시2</li>
                
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="chat-container">
        <div id="chat-messages">
          <div class="d">
            <div class="other-chat">sssssssssssssssssssssssssssssssss</div>
          </div>
          <div class="d">
            <div class="my-chat">cccsX</div>
          </div>
          <div class="d">
            <div class="other-chat">
              ascssssssssssssssssssssssssssssssssssssssssssssssssssszzzzzzzzXcZXcXCassssssssssssssssssssssssssssssssssssssssssssssssssssss
            </div>
          </div>
          <div class="d">
            <div class="my-chat">cccsX</div>
          </div>
        </div>
      </div>
      <div class="input-container">
        <form id="chatForm">
          <input type="text" id="message" placeholder="메세지 입력" />
          <button id="send_button">전송</button>
        </form>
      </div>
    </div>
    <script type="module" src="/auth.js"></script>

    <script>
      console.log("시작");
      const roomId = window.location.pathname.split("/").pop();

    

      if (roomId) {console.log("roomId:", roomId);} 
      else {
        console.log("roomId가 없습니다.");
      }

const myModal = document.getElementById("exampleModal");
const myInput = document.getElementById("myInput");

myModal.addEventListener("shown.bs.modal", () => {
  myInput.focus();
  updateUserList();
});


function fetchChatRoomInfo(roomId) {
  fetch(`/api/chat/${roomId}`)
    .then((response) => response.json())
    .then((data) => {
      const roomName = data.roomName;
      const titleElement = document.querySelector("#title");
      titleElement.textContent = roomName;
      updateUserList(data.userList); 
    })
    .catch((error) => {
      console.error("채팅방 정보 오류", error);
    });
}


fetchChatRoomInfo(roomId);

// 사용자 리스트를 업데이트하는 함수
function updateUserList(userList) {
  const userListContainer = document.querySelector("#userList");
  userListContainer.innerHTML = "";

  userList.forEach((user) => {
    const listItem = document.createElement("li");
    listItem.textContent = user.nick_name;

    if (user.nick_name === userNickname) {
      listItem.id = "username";
    }

    userListContainer.appendChild(listItem);
  });
}
      const socket = io();

      socket.on("connect", async () => {
        console.log("WebSocket 연결 성공");

        // 토큰 가져오기
        const token = await fetchUserToken();

        // 토큰이 있으면 방에 참여
        if (token) {
          joinRoom(roomId, token);
        } else {
          // 토큰이 없을 경우 처리
          console.error("토큰이 없습니다.");
        }
      });

      socket.on("disconnect", () => {
        console.log("WebSocket 연결이 해제되었습니다.");

      
      });

      const chatForm = document.querySelector("#chatForm");

      function joinRoom(roomId) {
        socket.emit("join room", roomId);
      }

      function loadPreviousMessages(token, roomId) {
        socket.emit("load previous messages", token, roomId);
      }

      socket.on("previous messages", (messages) => {
        displayPreviousMessages(messages);
      });

      function displayPreviousMessages(messages) {
        const chatMessages = document.querySelector("#chat-messages");

        messages.forEach((message) => {
          const formattedTime = new Date(message.send_at).toLocaleDateString();

          const messageContainer = document.createElement("div");
          messageContainer.classList.add("d");

          const messageItem = document.createElement("div");
          const messageClass =
            message.nick_name === userNickname ? "my-chat" : "other-chat";
          messageItem.classList.add(messageClass);

          if (messageClass === "other-chat") {
            messageItem.textContent = message.content;
          } else {
            messageItem.textContent = `(${formattedTime}): ${message.content}`;
          }

          messageContainer.appendChild(messageItem);

          chatMessages.appendChild(messageContainer);
        });
      }

      chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const messageInput = document.querySelector("#message");
        const message = messageInput.value;
        if (message) {
          fetchUserToken()
            .then((token) => {
              if (token) {
                sendMessage(message, token);
                messageInput.value = "";
              } else {
                console.error("토큰이 없습니다.");
              }
            })
            .catch((error) => {
              console.error("토큰 가져오기 오류:", error);
            });
        }
      });

      window.addEventListener("load", async () => {
        const token = await fetchUserToken();
        if (token) {
          loadPreviousMessages(token, roomId);
        } else {
          console.error("토큰이 없습니다.");
        }
      });
    </script>
  </body>
</html>
